name: Run bot
on:
  push:
  schedule:
    - cron: '0 */4 * * *'
jobs:
  run:
    if: contains(toJson(github.event.commits), '[ci skip]') == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout master branch
        uses: actions/checkout@v6 # https://github.com/actions/checkout
        with:
          ref: master
      - name: Setup Java
        uses: actions/setup-java@v5 # https://github.com/actions/setup-java
        with:
          distribution: 'temurin'
          java-version: 21
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5 # https://github.com/gradle/actions/tree/main/setup-gradle
        with:
          gradle-version: wrapper
      - name: Build app
        run: ./gradlew clean bootJar
      - name: Run app
        run: java -XX:+TieredCompilation -XX:TieredStopAtLevel=1 -Dfile.encoding=UTF-8 -jar build/libs/software-updates-bot-0.0.1-SNAPSHOT.jar
      - name: Commit and push changes
        run: |
          git add report/*.md
          git add report/*.json
          git add report/*.xml
          git add report/*.properties
          if [ -z "$(git status --porcelain)" ]; then
            echo "no changes detected"
            exit 0
          fi
          git config --local user.email "software-update-bot@lermitage.biz"
          git config --local user.name "Jonathan Lermitage software-updates-bot"
          git commit -m "autocommit by bot [ci skip]"
          git push
          echo "pushed changes"
